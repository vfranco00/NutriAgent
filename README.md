# NutriAgent ‚Äî Requisitos, Sprints e Entregas

> Backend com agente de IA para planejamento alimentar personalizado.

## üìö Sum√°rio
- [Vis√£o Geral](#-vis√£o-geral)
- [Requisitos Funcionais](#-requisitos-funcionais)
- [Requisitos N√£o Funcionais](#-requisitos-n√£o-funcionais)
- [Planejamento de Sprints](#-planejamento-de-sprints)
- [Entregas por Sprint (DoD)](#-entregas-por-sprint-definition-of-done)
- [Crit√©rios de Aceite](#-crit√©rios-de-aceite)
- [Riscos & Premissas](#-riscos--premissas)
- [Pr√≥ximos Passos](#-pr√≥ximos-passos)
- [Especifica√ß√µes T√©cnicas](#-especifica√ß√µes-t√©cnicas)
- [Como Rodar o Projeto](#Ô∏è-como-rodar-o-projeto)
- [Verifica√ß√£o R√°pida (cURL/Postman)](#-verifica√ß√£o-r√°pida-curlpostman)
- [Banco de Dados (psql)](#-banco-de-dados-psql)
- [Scripts √öteis (Makefile)](#-scripts-√∫teis-makefile)
- [Estrutura de Pastas (sugerida)](#-estrutura-de-pastas-sugerida)
- [Problemas Comuns (Troubleshooting)](#-problemas-comuns-troubleshooting)

---

## üéØ Vis√£o Geral
- **Objetivo:** gerar card√°pios e listas de compras personalizadas a partir do perfil nutricional do usu√°rio, com apoio de LLM.
- **Stack (MVP):** FastAPI ‚Ä¢ PostgreSQL ‚Ä¢ SQLAlchemy/Alembic ‚Ä¢ Docker ‚Ä¢ GitHub Actions ‚Ä¢ JWT/OAuth2
- **Conformidade:** LGPD (consentimento, minimiza√ß√£o e direito ao esquecimento)
- **P√∫blico-alvo:** pessoas com rotina corrida que precisam de praticidade e variedade na alimenta√ß√£o.

---

## ‚úÖ Requisitos Funcionais
1. **Autentica√ß√£o & Usu√°rios**
   - Cadastro, login via JWT, recupera√ß√£o de senha
   - Perfis: usu√°rio e admin (RBAC b√°sico)
2. **Perfil Nutricional**
   - Prefer√™ncias (gostos/avers√µes), restri√ß√µes (alergias/intoler√¢ncias)
   - Metas (emagrecimento, manuten√ß√£o, ganho de massa)
3. **Receitas & Ingredientes**
   - CRUD de receitas e ingredientes com unidades (g, ml, colheres)
   - C√°lculo autom√°tico de calorias e macronutrientes por por√ß√£o
4. **Planejamento de Refei√ß√µes**
   - Gera√ß√£o autom√°tica de **plano semanal (21 refei√ß√µes)** pelo agente de IA
   - Travar/editar refei√ß√µes e substituir pratos
5. **Lista de Compras**
   - Consolida√ß√£o de ingredientes do plano semanal
   - Exporta√ß√£o em **CSV** e **PDF**
6. **Chat/Assistente de IA**
   - Ajustes do plano e d√∫vidas sobre receitas
   - Hist√≥rico por usu√°rio
7. **Admin & Auditoria**
   - Painel de m√©tricas, gerenciamento de usu√°rios e logs
   - Gest√£o de termos e consentimento
8. **Integra√ß√µes**
   - E-mail transacional (confirma√ß√£o/reset)
   - Provider de LLM configur√°vel por vari√°vel de ambiente

---

## üõ°Ô∏è Requisitos N√£o Funcionais
- **Desempenho**
  - P95 < **300 ms** em endpoints CRUD
  - P95 < **1,5 s** para gera√ß√£o de plano semanal
- **Disponibilidade**
  - Meta **99,5%** (MVP)
  - Backups di√°rios; **RPO 24h** e **RTO 4h**
- **Seguran√ßa**
  - Hash de senhas (bcrypt/argon2), JWT com expira√ß√£o/refresh
  - Rate limiting, valida√ß√£o forte de entrada, prote√ß√£o a brute force
  - LGPD: consentimento, minimiza√ß√£o, exclus√£o de dados
- **Escalabilidade & Infra**
  - Conteineriza√ß√£o (Docker); filas para tarefas pesadas e cache pontual
- **Observabilidade**
  - Logs estruturados (JSON), m√©tricas (OpenTelemetry), tracing
- **Qualidade**
  - Testes unit√°rios/integrados, **cobertura ‚â• 70%** no MVP
  - CI com lint, testes e migrations

---

## üó∫Ô∏è Planejamento de Sprints (2 semanas)

| Sprint | Per√≠odo (America/Sao_Paulo) | Objetivos-chave |
|---|---|---|
| **1** | **07‚Äì20/10/2025** | Setup do backend (FastAPI), estrutura, Docker, PostgreSQL; Auth/JWT, usu√°rios; Alembic; seeds; CI b√°sico |
| **2** | **21/10‚Äì03/11/2025** | CRUD de receitas/ingredientes e perfis; c√°lculos de macros; lista de compras inicial |
| **3** | **04‚Äì17/11/2025** | Integra√ß√£o LLM, prompts/guardrails; gera√ß√£o/edi√ß√£o de plano semanal; hist√≥rico de chat; exporta√ß√µes |
| **4** | **18/11‚Äì01/12/2025** | Hardening (seguran√ßa, LGPD), rate limit; observabilidade; tuning e guia de deploy |

---

## üì¶ Entregas por Sprint (Definition of Done)

### ‚úÖ Sprint 1 ‚Äî Funda√ß√£o do Backend
- [ ] Reposit√≥rio organizado e **Docker Compose** funcional
- [ ] Banco com **migrations Alembic** + **seeds**
- [ ] **Auth/Users** operando (cadastro, login, /me)
- [ ] **OpenAPI** dispon√≠vel e **CI** com lint/testes iniciais

### ‚úÖ Sprint 2 ‚Äî Dom√≠nio Core
- [ ] CRUD de **receitas**, **ingredientes** e **perfil nutricional**
- [ ] C√°lculo validado de **macros** e **calorias**
- [ ] Scripts de **seed** e exemplos de payload
- [ ] **Cobertura de testes ‚â• 60%**

### ‚úÖ Sprint 3 ‚Äî IA & Plano Semanal
- [ ] Provider de **LLM** configur√°vel (env)
- [ ] **Gera√ß√£o do plano semanal** (21 refei√ß√µes) e **edi√ß√£o**
- [ ] **Hist√≥rico** do chat por usu√°rio
- [ ] **Exporta√ß√µes CSV/PDF** e cache pontual

### ‚úÖ Sprint 4 ‚Äî Hardening & Deploy
- [ ] **Rate limiting**, valida√ß√µes e pol√≠ticas LGPD
- [ ] **Logs, m√©tricas e tracing** com dashboards
- [ ] Guia de **deploy** e **Release Candidate** tagueado

---

## üß™ Crit√©rios de Aceite
- **Autentica√ß√£o**  
  *Dado* um usu√°rio cadastrado, *quando* loga com credenciais v√°lidas, *ent√£o* recebe JWT e acessa **/me**.

- **Plano Semanal**  
  *Dadas* prefer√™ncias e metas, *quando* solicita plano, *ent√£o* recebe **21 refei√ß√µes** com macros por dia.

- **Lista de Compras**  
  *Dado* um plano gerado, *quando* exporta, *ent√£o* obt√©m **CSV/PDF** com totais por ingrediente.

- **LGPD ‚Äî Exclus√£o**  
  *Dado* um pedido de exclus√£o, *quando* confirmado, *ent√£o* dados pessoais s√£o removidos e acesso revogado.

---

## ‚ö†Ô∏è Riscos & üìå Premissas
**Riscos**
- Custos/limites do provider de LLM impactarem lat√™ncia/or√ßamento
- Dados de receitas inconsistentes afetarem c√°lculos
- Crescimento de escopo em features de IA (scope creep)

**Premissas**
- Equipe com acesso a Docker e PostgreSQL
- Contas ativas para e-mail transacional e LLM
- Sprints quinzenais com cerim√¥nias √°geis

---

## ‚ñ∂Ô∏è Pr√≥ximos Passos
1. Refinar backlog em **√©picos ‚Üí hist√≥rias ‚Üí tarefas** com estimativas
2. Priorizar √©picos do **MVP**
3. Definir **staging** e pipeline de **deploy**
4. Fixar m√©tricas de **P95**, **cobertura** e **disponibilidade**

---

## üîß Especifica√ß√µes T√©cnicas

### Stack e vers√µes (sugeridas)
- **Linguagem:** Python 3.11+
- **Web Framework:** FastAPI
- **ASGI Server:** Uvicorn
- **ORM:** SQLAlchemy 2.x + Alembic (migrations)
- **Banco de Dados:** PostgreSQL 16
- **Autentica√ß√£o:** OAuth2 + JWT (PyJWT)
- **Testes:** Pytest + Coverage
- **Qualidade:** Ruff (lint), Black (format), MyPy (types)
- **Containeriza√ß√£o:** Docker & Docker Compose
- **CI/CD:** GitHub Actions (lint, testes, migrations)
- **Observabilidade:** Logs estruturados (JSON), OpenTelemetry (m√©tricas/tracing opcional)

### Arquitetura (alto n√≠vel)
- **app/**
  - `main.py` ‚Äì ponto de entrada do FastAPI (inclui routers e middlewares)
  - `core/` ‚Äì configs globais (settings, security, logging)
  - `db/` ‚Äì engine, sess√£o, base declarativa, reposit√≥rios
  - `models/` ‚Äì modelos SQLAlchemy
  - `schemas/` ‚Äì Pydantic (request/response)
  - `routers/` ‚Äì controladores (auth, users, recipes, plans, admin, etc.)
  - `services/` ‚Äì regras de neg√≥cio (IA, c√°lculo de macros, lista de compras)
  - `llm/` ‚Äì clients e prompts; provider configur√°vel via env
  - `utils/` ‚Äì helpers (e-mail, pdf/csv export, rate limiting)
- **migrations/** ‚Äì vers√µes do Alembic
- **tests/** ‚Äì testes unit√°rios e integrados
- **docker/** ‚Äì arquivos de infra (Dockerfile, compose, entrypoints)

### Principais Endpoints (exemplos)
- `POST /auth/signup`, `POST /auth/login`, `GET /auth/me`
- `GET/POST/PUT/DELETE /recipes`, `GET /recipes/{id}`
- `GET/POST /ingredients`
- `POST /plan/generate` (gera 7 dias/21 refei√ß√µes)
- `GET /shopping-list/export?format=csv|pdf`
- `GET /chat/history`, `POST /chat/message`
- `DELETE /admin/user/{id}` (RBAC: admin)

### Vari√°veis de Ambiente (.env ‚Äî exemplo)
```
# Banco
DATABASE_URL=postgresql+psycopg://nutri:nutri@db:5432/nutri

# JWT
JWT_SECRET=troque-este-segredo
JWT_EXPIRES_MINUTES=60
JWT_ALGORITHM=HS256

# E-mail (opcional)
MAIL_HOST=smtp.example.com
MAIL_PORT=587
MAIL_USERNAME=seu_usuario
MAIL_PASSWORD=sua_senha
MAIL_FROM=noreply@nutriagent.app
MAIL_TLS=true

# LLM (opcional)
LLM_PROVIDER=openai
OPENAI_API_KEY=xxxx

# App
APP_ENV=development
LOG_LEVEL=INFO
```

> **Dica:** Em dev local sem Docker, troque o host para `localhost` no `DATABASE_URL`.

### Padr√µes de C√≥digo
- **Lint:** `ruff check .`
- **Format:** `black .`
- **Tipos:** `mypy app`

### Testes
- **Executar:** `pytest -q`
- **Cobertura:** `coverage run -m pytest && coverage report -m`

---

## ‚ñ∂Ô∏è Como rodar o projeto

> Escolha **Docker** (recomendado) ou **ambiente local** (Python).

### Op√ß√£o A ‚Äî Docker (One-liner)
Requisitos: Docker + Docker Compose

```bash
# 1) Copie .env.example para .env e ajuste as vari√°veis
cp .env.example .env   # se existir; sen√£o crie manualmente

# 2) Suba os servi√ßos (API + Postgres)
docker compose up -d --build

# 3) Rode as migrations dentro do container da API
docker compose exec api alembic upgrade head

# 4) (Opcional) rode seeds/dados de exemplo
docker compose exec api python -m app.seed

# 5) Acesse a API
# Swagger UI: http://localhost:8000/docs
# OpenAPI JSON: http://localhost:8000/openapi.json
```

**Atalhos √∫teis**
```bash
# Logs
docker compose logs -f api

# Reiniciar API
docker compose restart api

# Derrubar tudo
docker compose down -v
```

### Op√ß√£o B ‚Äî Ambiente local (Python)
Requisitos: Python 3.11+, PostgreSQL 16

```bash
# 1) Crie e ative o virtualenv
python -m venv .venv
# macOS/Linux:
source .venv/bin/activate
# Windows (PowerShell):
.venv\Scripts\Activate.ps1

# 2) Instale depend√™ncias
pip install -U pip
pip install -r requirements.txt

# 3) Exporte as vari√°veis de ambiente (ou use um .env com python-dotenv)
# macOS/Linux:
export DATABASE_URL="postgresql+psycopg://nutri:nutri@localhost:5432/nutri"
export JWT_SECRET="troque-este-segredo"
# Windows (PowerShell):
setx DATABASE_URL "postgresql+psycopg://nutri:nutri@localhost:5432/nutri"
setx JWT_SECRET "troque-este-segredo"

# 4) Crie o banco (se necess√°rio) e rode as migrations
alembic upgrade head

# 5) (Opcional) seeds
python -m app.seed

# 6) Suba a API
uvicorn app.main:app --reload --port 8000

# Acesse:
# http://localhost:8000/docs
```

---

## üîé Verifica√ß√£o R√°pida (cURL/Postman)
```bash
# Signup
curl -X POST http://localhost:8000/auth/signup \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"Senha@123","name":"User"}'

# Login (obtenha access_token)
TOKEN=$(curl -s -X POST http://localhost:8000/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"Senha@123"}' | jq -r .access_token)

# /me autenticado
curl http://localhost:8000/auth/me -H "Authorization: Bearer $TOKEN"
```

---

## üóÑÔ∏è Banco de Dados (psql)
```bash
# Via Docker
docker compose exec db psql -U nutri -d nutri

# Local
psql -h localhost -U nutri -d nutri
```

---

## üß∞ Scripts √öteis (Makefile)
```bash
make up        # sobe docker compose
make migrate   # alembic upgrade head
make seed      # popular dados iniciais
make test      # pytest
make down      # docker compose down -v
```

---

## üóÇÔ∏è Estrutura de Pastas (sugerida)
```
.
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ main.py
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ settings.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ security.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logging.py
‚îÇ   ‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ session.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ repositories/
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îú‚îÄ‚îÄ routers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ recipes.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ingredients.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ plans.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ admin.py
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ plan_service.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ shopping_list_service.py
‚îÇ   ‚îú‚îÄ‚îÄ llm/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ provider.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prompts.py
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îú‚îÄ‚îÄ email.py
‚îÇ       ‚îú‚îÄ‚îÄ export_csv.py
‚îÇ       ‚îî‚îÄ‚îÄ export_pdf.py
‚îú‚îÄ‚îÄ migrations/
‚îú‚îÄ‚îÄ tests/
‚îú‚îÄ‚îÄ docker/
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îî‚îÄ‚îÄ entrypoint.sh
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ alembic.ini
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ .env.example
‚îî‚îÄ‚îÄ README.md
```

---

## üÜò Problemas Comuns (Troubleshooting)
- **`Connection refused` no Postgres:** aguarde o container `db` iniciar ou revise `DATABASE_URL`.
- **Migrations n√£o rodam:** verifique `alembic.ini` e `target_metadata` do seu `Base`.
- **JWT inv√°lido/expirado:** gere novo token com `/auth/login` e confira `JWT_EXPIRES_MINUTES`.
- **CORS em frontend:** habilite middleware CORS em `app/main.py` com origins do seu front.
- **Erro ao exportar PDF/CSV:** confirme libs/bibliotecas instaladas e permiss√µes de escrita (pasta temp/exports).
